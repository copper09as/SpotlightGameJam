local GC = CS.GameController

function CharacterCrossMap(entity)
    local cam = CS.UnityEngine.Camera.main
    local pos = entity.transform.position
    local data = entity.dataTable
	
    -- 获取屏幕坐标
    local screenPos = cam:WorldToScreenPoint(pos)
    local screenWidth = CS.UnityEngine.Screen.width
    local offset = 1 -- 像素偏移，防止重复传送

    -- 初始化穿越记录
    if data.lastCrossDirection == nil then
        data.lastCrossDirection = 0
    end

    local crossed = false
    local direction = 0 -- -1 左穿越，1 右穿越

    -- 超出左侧
    if screenPos.x < 0 then
        direction = -1
        crossed = true
    -- 超出右侧
    elseif screenPos.x > screenWidth then
        direction = 1
        crossed = true
    end

    -- 判断是否重复穿越
    if crossed then
        if direction == data.lastCrossDirection then
            -- 重复穿越，取消传送，只偏移一点点
            local adjust = (direction == -1) and 10 or -10
            local worldPos = cam:ScreenToWorldPoint(CS.UnityEngine.Vector3(screenPos.x + adjust, screenPos.y, screenPos.z))
            entity.transform.position = CS.UnityEngine.Vector3(worldPos.x, pos.y, pos.z)
        else
            -- 正常传送
            if direction == -1 then
                screenPos.x = screenWidth - offset
            else
                screenPos.x = 0 + offset
            end
            local worldPos = cam:ScreenToWorldPoint(screenPos)
            entity.transform.position = CS.UnityEngine.Vector3(worldPos.x, pos.y, pos.z)
            data.lastCrossDirection = direction
        end
    else
        data.lastCrossDirection = 0 -- 在屏幕内，重置记录
    end
end
