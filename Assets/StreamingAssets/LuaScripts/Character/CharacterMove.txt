local GC = CS.GameController
local DM = CS.DetectionManager
function CharacterMove(entity)
    if entity.rb == nil then return end

    local data = entity.dataTable
    local rb = entity.rb
    local x = GC:MoveX() -- 玩家输入方向
    local speed = data.characterSpeed or 10

    -- 计算目标速度
    local targetSpeed = x * speed
    local accelRate = (math.abs(targetSpeed) > 0.01) and (data.runAccelAmount or 10) 
                                                or (data.runDeccelAmount or 10)
    local speedDif = targetSpeed - rb.velocity.x
    local movement = speedDif * accelRate

    -- 缩放系数
    --local camera = CS.UnityEngine.Camera.main
    --local rawFactor = camera.orthographicSize / (data.defaultCamSize or 5.19)
	local rawFactor = entity.transform.localScale.x/0.3
    local scaleFactor = rawFactor > 1 and rawFactor or 0.5 + 0.5 * rawFactor

    rb:AddForce(CS.UnityEngine.Vector2(movement * scaleFactor, 0), CS.UnityEngine.ForceMode2D.Force)
    local origin = CS.UnityEngine.Vector2(
        entity.transform.position.x,
        entity.col.bounds.min.y
    )
    local groundCheck = DM.Raycast2D(origin, CS.UnityEngine.Vector2(0, -1), data.rayLen, "Ground")
    CS.UnityEngine.Debug.DrawRay(CS.UnityEngine.Vector3(origin.x, origin.y, 0), CS.UnityEngine.Vector3(0, -data.rayLen, 0), CS.UnityEngine.Color.red)
	
    -- ====== 动画控制 ======
    if entity.animator ~= nil and groundCheck then
	
        local threshold = 0.1

        -- 翻转方向，根据 MoveX
        if x > threshold then
            entity.sr.flipX = false  -- 右移
        elseif x < -threshold then
            entity.sr.flipX = true   -- 左移
        end
		CS.UnityEngine.Debug.Log(x)
        -- 动画切换，根据速度播放 Walk 或 Idle
        if math.abs(rb.velocity.x) > threshold then
            entity.animator:Play("Walk")
        else
            entity.animator:Play("Idle")
        end
    end
end
