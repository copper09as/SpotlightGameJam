local DM = CS.DetectionManager

function StickPlayerUp(entity)
    local tag = "Player"
    local data = entity.dataTable
    local hitEntityTrans = entity.transform
    local hitEntityPos = hitEntityTrans.position
    local colBounds = entity.col.bounds
    local halfWidth = colBounds.extents.x
    local halfHeight = colBounds.extents.y
    local raysCount = 12
    local step = (halfWidth * 2) / (raysCount - 1)
    local hitCharacter = nil

    -- ğŸŒ¿ å°„çº¿æ£€æµ‹ç©å®¶ï¼ˆä¸Šæ–¹å‘ï¼‰
    for i = 0, raysCount - 1 do
        local offsetX = -halfWidth + i * step
        local origin = CS.UnityEngine.Vector2(
            hitEntityPos.x + offsetX,
            hitEntityPos.y + halfHeight + 0.02
        )

        local character = DM.Raycast2DByTag(origin, CS.UnityEngine.Vector2(0, 1), 0.3, tag)

        CS.UnityEngine.Debug.DrawRay(
            CS.UnityEngine.Vector3(origin.x, origin.y, 0),
            CS.UnityEngine.Vector3(0, 0.2, 0),
            CS.UnityEngine.Color.green
        )

        if character then
            hitCharacter = character
            break
        end
    end

    -- ğŸ“Œ æ£€æµ‹åˆ°è§’è‰²
    if hitCharacter then
        data.hitCharacter = hitCharacter

        -- è·å–åˆšä½“ç»„ä»¶
        local rb = hitCharacter:GetComponent(typeof(CS.UnityEngine.Rigidbody2D))
        if rb then
            -- å¦‚æœæ˜¯é¦–æ¬¡æ¥è§¦ï¼Œåˆ™å¢åŠ é‡åŠ›
            if not data.originalGravity then
                data.originalGravity = rb.gravityScale
                rb.gravityScale = data.originalGravity * 20  -- âœ¨ å¢å¤§é‡åŠ›
            end
        end

        -- X æ–¹å‘å¸é™„
        if not data.hitLocalPosition then
            data.hitLocalPosition = hitEntityTrans:InverseTransformPoint(hitCharacter.transform.position)
        end

        local currentLocalPos = hitEntityTrans:InverseTransformPoint(hitCharacter.transform.position)
        local targetX = data.hitLocalPosition.x

        -- æŠŠ X ä½ç½®é”åœ¨ stick ç‚¹ä¸Š
        local targetWorldX = hitEntityTrans:TransformPoint(
            CS.UnityEngine.Vector3(targetX, currentLocalPos.y, 0)
        ).x

        -- ä¿æŒ Y ä¸åŠ¨
        local currentY = hitCharacter.transform.position.y

        hitCharacter.transform.position = CS.UnityEngine.Vector3.Lerp(
            hitCharacter.transform.position,
            CS.UnityEngine.Vector3(targetWorldX, currentY, hitCharacter.transform.position.z),
            0.25
        )

        return
    end

    -- âŒ ç¦»å¼€æ»‘å—æ—¶ï¼Œé‡ç½®é‡åŠ›
    if data.hitCharacter and data.originalGravity then
        local rb = data.hitCharacter:GetComponent(typeof(CS.UnityEngine.Rigidbody2D))
        if rb then
            rb.gravityScale = data.originalGravity
        end
    end

    data.hitCharacter = nil
    data.hitLocalPosition = nil
    data.originalGravity = nil
end
