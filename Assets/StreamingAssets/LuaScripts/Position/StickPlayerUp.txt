local DM = CS.DetectionManager

function StickPlayerUp(entity)
    local tag = "Player"
    local data = entity.dataTable
    local hitEntityPos = entity.transform.position
    local halfWidth = entity.col.bounds.extents.x
    local halfHeight = entity.col.bounds.extents.y
    local raysCount = 10
    local step = (halfWidth * 2) / (raysCount - 1)
    local hitCharacter

    -- ğŸŒ¿ å°„çº¿æ£€æµ‹ç©å®¶ï¼ˆä¸Šæ–¹å‘ï¼‰
    for i = 0, raysCount - 1 do
        local offsetX = -halfWidth + i * step
        local origin = CS.UnityEngine.Vector2(hitEntityPos.x + offsetX, hitEntityPos.y + halfHeight + 0.01)

        local character = DM.Raycast2DByTag(origin, CS.UnityEngine.Vector2(0, 1), 0.2, tag)

        CS.UnityEngine.Debug.DrawRay(
            CS.UnityEngine.Vector3(origin.x, origin.y, 0),
            CS.UnityEngine.Vector3(0, 0.1, 0),
            CS.UnityEngine.Color.green
        )

        if character then
            hitCharacter = character
            break
        end
    end

    -- ğŸ“Œ æœ‰æ£€æµ‹åˆ°è§’è‰²
    if hitCharacter then
        local currentOffset = hitCharacter.transform.position - entity.transform.position

        -- ç¬¬ä¸€æ¬¡è®°å½•åç§»
        if not data.hitPosition then
            data.hitPosition = currentOffset
        else
            -- åç§»å¤ªå¤§å°±é‡ç½®ï¼ˆé˜²æ­¢å¡é¡¿è¯¯å·®ï¼‰
            local maxDistance = 0.1 
            if (currentOffset - data.hitPosition).magnitude > maxDistance then
                data.hitPosition = currentOffset
            end
        end

        -- ä¿æŒç›¸å¯¹ä½ç½® X + Y ä¸€è‡´
        local targetPos = entity.transform.position + data.hitPosition
        hitCharacter.transform.position = CS.UnityEngine.Vector3(
            targetPos.x,
            targetPos.y,
            hitCharacter.transform.position.z
        )

        data.hitCharacter = hitCharacter
        return
    end

    -- âŒ æ²¡æœ‰æ£€æµ‹åˆ°è§’è‰²ï¼Œæ¸…ç©º
    data.hitCharacter = nil
    data.hitPosition = nil
end
